<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: persistent rate limiting</title><meta content="
base-uri    &apos;self&apos;;
form-action &apos;self&apos;;
default-src &apos;none&apos;;
script-src  &apos;self&apos;;
img-src     &apos;self&apos;;
font-src    &apos;self&apos;;
connect-src &apos;self&apos;;
style-src   &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><script src="/toggle.js"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="A blog mostly about programming." name="description" /></head><body><nav class="container"><ul><li><div class="linkify" style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;">anders murphy</h1><a href="/"></a></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li><li><div class="theme-toggle" id="toggle"><svg aria-hidden="true" class="icon theme-toggle__inner-moon" height="30" viewBox="0 0 32 32" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M27.5 11.5v-7h-7L16 0l-4.5 4.5h-7v7L0 16l4.5 4.5v7h7L16 32l4.5-4.5h7v-7L32 16l-4.5-4.5zM16 25.4a9.39 9.39 0 1 1 0-18.8 9.39 9.39 0 1 1 0 18.8z"></path><circle cx="16" cy="16" r="8.1"></circle></svg></div></li></ul></nav><div class="container"><article><hgroup><h1>Clojure: persistent rate limiting</h1><p><time datetime="2020-02-08T00:00:00+00:00">08 Feb 2020</time></p></hgroup><hr /><p>Some business needs require you to limit the number of times you do something. An example of this would be sending a daily email to users. You could achieve this by making sure you run the function only once per day. However, if that function were to crash part way through how would you know which users had already been sent their daily email and which hadn't? Resolving this without sending some users multiple emails could be a large time sink. A more robust solution would be to make the email sending function idempotent; meaning the effects of the function are applied only once per user per day and any additional applications do nothing. This article will explore one approach to solving this problem in Clojure.</p><p>As this is a solution that relies on persistence, we first need to set up a database:</p><pre><code class="Clojure"><span class="dim">&#40;</span>ns <strong>do-once.core</strong>
  <span class="dim">&#40;</span>:require &#91;next.jdbc :as jdbc&#93;<span class="dim">&#41;&#41;</span>

<span class="dim">&#40;</span>def <strong>db</strong> {:dbtype &quot;postgresql&quot; :dbname &quot;databasename&quot;}<span class="dim">&#41;</span>
<span class="dim">&#40;</span>def <strong>ds</strong> <span class="dim">&#40;</span>jdbc/get-datasource db<span class="dim">&#41;&#41;</span>
</code></pre><p>We need a function that queries the database to check if a task has already been done:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>done?</strong> &#91;uuid name&#93;
  <span class="dim">&#40;</span>jdbc/execute-one! ds &#91;&quot;
select &#42; from do&#95;once where uuid = ? and name = ?&quot;
                         uuid name&#93;<span class="dim">&#41;&#41;</span>
</code></pre><p>We need a function that records a task that has been done:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>do!</strong> &#91;uuid name&#93;
  <span class="dim">&#40;</span>jdbc/execute! ds &#91;&quot;
insert into do&#95;once <span class="dim">&#40;</span>uuid, name<span class="dim">&#41;</span> values <span class="dim">&#40;</span>? , ?<span class="dim">&#41;</span> on conflict <span class="dim">&#40;</span>uuid, name<span class="dim">&#41;</span> do nothing&quot;
                     uuid name&#93;<span class="dim">&#41;&#41;</span>
</code></pre><p>We need a table for recording our tasks:</p><pre><code class="Clojure"><span class="dim">&#40;</span>jdbc/execute! ds &#91;&quot;
create table do&#95;once <span class="dim">&#40;</span>
  pid serial primary key,
  uuid text not null,
  name text not null<span class="dim">&#41;</span>&quot;&#93;<span class="dim">&#41;</span>

  <span class="dim">&#40;</span>jdbc/execute! ds &#91;&quot;
create unique index do&#95;once&#95;unique ON do&#95;once<span class="dim">&#40;</span>uuid, name<span class="dim">&#41;</span>&quot;&#93;<span class="dim">&#41;</span>
</code></pre><p>We need a macro that records the task:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defmacro <strong>do-once!</strong> &#91;uuid name &amp; body&#93;
  `<span class="dim">&#40;</span>when-not <span class="dim">&#40;</span>done? &#126;uuid &#126;name<span class="dim">&#41;</span>
     <span class="dim">&#40;</span>do! &#126;uuid &#126;name<span class="dim">&#41;</span>
     &#126;@body<span class="dim">&#41;&#41;</span>
</code></pre><p>We can now send an email to Nora:</p><pre><code class="Clojure"><span class="dim">&#40;</span>do-once! &quot;Nora&quot; &quot;email-2020-02-08&quot;
            <span class="dim">&#40;</span>println &quot;email sent&quot;<span class="dim">&#41;</span>
            <span class="dim">&#40;</span>prn <span class="dim">&#40;</span>+ 1 2 3 4<span class="dim">&#41;&#41;&#41;</span>
<span class="dim">
=&gt;</span> email sent

10
</code></pre><p>If we try to send Nora a second email that day, it doesn't get sent:</p><pre><code class="Clojure"><span class="dim">&#40;</span>do-once! &quot;Nora&quot; &quot;email-2020-02-08&quot;
            <span class="dim">&#40;</span>println &quot;email sent&quot;<span class="dim">&#41;</span>
            <span class="dim">&#40;</span>prn <span class="dim">&#40;</span>+ 1 2 3 4<span class="dim">&#41;&#41;&#41;</span>
<span class="dim">
=&gt;</span> nil
</code></pre><p>We can use a macro with named parameters to make things more explicit:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defmacro <strong>do-once-2!</strong> &#91;&amp; {:keys &#91;uuid name action&#93;}&#93;
  `<span class="dim">&#40;</span>when-not <span class="dim">&#40;</span>done? &#126;uuid &#126;name<span class="dim">&#41;</span>
     <span class="dim">&#40;</span>do! &#126;uuid &#126;name<span class="dim">&#41;</span>
     &#126;action<span class="dim">&#41;&#41;</span>

<span class="dim">&#40;</span>do-once-2! :uuid &quot;Nora&quot;
            :name &quot;email-2020-02-09&quot;
            :action <span class="dim">&#40;</span>do <span class="dim">&#40;</span>println &quot;email sent&quot;<span class="dim">&#41;</span>
                        <span class="dim">&#40;</span>prn <span class="dim">&#40;</span>+ 1 2 3 4<span class="dim">&#41;&#41;&#41;&#41;</span>
<span class="dim">
=&gt;</span> email sent

10
</code></pre><p>Or just a plain old function that takes data:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>do-once-3!</strong> &#91;{:keys &#91;uuid name action&#93;}&#93;
  <span class="dim">&#40;</span>when-not <span class="dim">&#40;</span>done? uuid name<span class="dim">&#41;</span>
    <span class="dim">&#40;</span>do! uuid name<span class="dim">&#41;</span>
    <span class="dim">&#40;</span>action<span class="dim">&#41;&#41;&#41;</span>

<span class="dim">&#40;</span>do-once-3! {:uuid   &quot;Nora&quot;
             :name   &quot;email-2020-02-10&quot;
             :action <span class="dim">&#40;</span>fn &#91;&#93;
                        <span class="dim">&#40;</span>println &quot;email sent&quot;<span class="dim">&#41;</span>
                        <span class="dim">&#40;</span>prn <span class="dim">&#40;</span>+ 1 2 3 4<span class="dim">&#41;&#41;&#41;</span>}<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span> email sent

10
</code></pre><p>That covers this approach to persistent rate limiting in Clojure. The full example <a href='https://github.com/andersmurphy/clj-cookbook/tree/master/rate-limiting/do-once'>project can be found here</a>.</p></article><footer><p>© 2015-2024 Anders Murphy</p></footer></div></body></html>