<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: check if instant happened today at timezone</title><meta content="
base-uri    &apos;self&apos;;
form-action &apos;self&apos;;
default-src &apos;none&apos;;
script-src  &apos;self&apos;;
img-src     &apos;self&apos;;
font-src    &apos;self&apos;;
connect-src &apos;self&apos;;
style-src   &apos;self&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="https://andersmurphy.com/styles.css" rel="stylesheet" type="text/css" /><link href="https://andersmurphy.com/assets/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144" /><link href="https://andersmurphy.com/assets/favicon.ico" rel="shortcut icon" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="A blog mostly about software development." name="description" /></head><body><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><img alt="portrait" class="portrait" height="120" src="https://andersmurphy.com/assets/anderspixel.png" width="60" /><h1><a href="https://andersmurphy.com/">Anders Murphy</a></h1><p class="lead">A blog mostly about functional programming</p></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="https://github.com/andersmurphy">Github</a><a class="sidebar-nav-item" href="https://twitter.com/anders_murphy">Twitter</a><a class="sidebar-nav-item" href="https://uk.linkedin.com/in/anders-murphy-76457b3a">LinkedIn</a><a class="sidebar-nav-item" href="https://andersmurphy.com/feed.xml">RSS</a></nav></div></div><div class="content container"><article class="post"><h1 class="post-title">Clojure: check if instant happened today at timezone</h1><time class="post-date" datetime="2021-12-04T00:00:00+00:00">04 Dec 2021</time><p>Say you are making a digital advent calendar app. You want users to get a special reward on the days that they open your app. But only once per day and only on the days they open the app. This sounds straight forward. What about time zones? What about users who open the app on the 1st of December at 23:55 and then on the 2nd of December at 00:03? Time is tricky.</p><p>We will be using <code>java.time</code> as it comes with Clojure out of the box. Unfortunately, there are no built in reader literals for <code>java.time.Instant</code> (<a href='https://andersmurphy.com/2019/08/03/clojure-using-java-time-with-jdbc.html#reader_literals'>checkout this post for how to add them</a>). Throughout this example we will use the code below to create a <code>java.time.Instant</code> from a <code>java.util.Date</code> literal:</p><pre><code class="Clojure"><span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-04T00:00:00Z&quot;<span class="dim">&#41;</span>
</code></pre><p>First lets open some javadoc from the repl. The <code>javadoc</code> function opens your default browser and points it to the relevant documentation:</p><pre><code class="Clojure"><span class="dim">&#40;</span>clojure.java.javadoc/javadoc java.time.Instant<span class="dim">&#41;</span>
<span class="dim">&#40;</span>clojure.java.javadoc/javadoc java.time.ZoneId<span class="dim">&#41;</span>
</code></pre><p>Looking over the <code>java.time</code> documentation we can piece together the following function:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>instant-&gt;localDate-at-timezone</strong> &#91;instant tz&#93;
  <span class="dim">&#40;</span>-&gt;&gt; <span class="dim">&#40;</span>java.time.ZoneId/of tz<span class="dim">&#41;</span>
       <span class="dim">&#40;</span>.atZone instant<span class="dim">&#41;</span>
       <span class="dim">&#40;</span>.toLocalDate<span class="dim">&#41;&#41;&#41;</span>
</code></pre><p>This seems to work:</p><pre><code class="Clojure"><span class="dim">&#40;</span>instant-&gt;localDate-at-timezone
 <span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-04T00:00:00Z&quot;<span class="dim">&#41;</span> &quot;UTC&quot;<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
#object&#91;java.time.LocalDate 0x73ad4ecc &quot;2021-12-04&quot;&#93;
</code></pre><p>Whenever you I use Java interop I like to make sure I'm not inadvertently doing any reflection. Reflection is expensive and can easily be avoided in most cases by adding some type hints. Thankfully, Clojure can warn us on reflection use by setting <code>&#42;warn-on-reflection&#42;</code> to <code>true</code>:</p><pre><code class="Clojure"><span class="dim">&#40;</span>set! &#42;warn-on-reflection&#42; true<span class="dim">&#41;</span>
</code></pre><p>If we evaluate the <code>instant-&gt;localDate-at-timezone</code> definition again we will get the following warning:</p><pre><code class="Clojure">Reflection warning ...
- call to method atZone can't be resolved
<span class="dim">&#40;</span>target class is unknown<span class="dim">&#41;</span>
</code></pre><p>This can easily be fixed by adding the <code>&#94;java.time.Instant</code> type hint:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>instant-&gt;localDate-at-timezone</strong> &#91;instant tz&#93;
  <span class="dim">&#40;</span>-&gt;&gt; <span class="dim">&#40;</span>java.time.ZoneId/of tz<span class="dim">&#41;</span>
       <span class="dim">&#40;</span>.atZone &#94;java.time.Instant instant<span class="dim">&#41;</span>
       <span class="dim">&#40;</span>.toLocalDate<span class="dim">&#41;&#41;&#41;</span>
</code></pre><p>You won't see any more warnings. So let's set <code>&#42;warn-on-reflection&#42;</code> back to <code>nil</code>:</p><pre><code class="Clojure"><span class="dim">&#40;</span>set! &#42;warn-on-reflection&#42; nil<span class="dim">&#41;</span>
</code></pre><p>Let's find some more time zones to test this function on. I can never remember the exact ids, but that's fine as we can just ask Java:</p><pre><code class="Clojure"><span class="dim">&#40;</span>-&gt;&gt; <span class="dim">&#40;</span>java.time.ZoneId/getAvailableZoneIds<span class="dim">&#41;</span>
     <span class="dim">&#40;</span>filter #<span class="dim">&#40;</span>clojure.string/includes? % &quot;Pacific&quot;<span class="dim">&#41;&#41;&#41;</span>
<span class="dim">
=&gt;</span>
<span class="dim">&#40;</span>&quot;Canada/Pacific&quot;
 &quot;Pacific/Apia&quot;
 &quot;Pacific/Auckland&quot;
 &quot;Pacific/Bougainville&quot;
 &quot;Pacific/Chatham&quot;
 &quot;Pacific/Chuuk&quot;
 &quot;Pacific/Easter&quot;
 &quot;Pacific/Efate&quot;
 &quot;Pacific/Enderbury&quot;
 &quot;Pacific/Fakaofo&quot;
 &quot;Pacific/Fiji&quot;
 ...<span class="dim">&#41;</span>
</code></pre><p>Testing the function with  <code>&quot;Pacific/Fiji&quot;</code> gives us the correct date (2021-12-05) rather than the 2021-12-04):</p><pre><code class="Clojure"><span class="dim">&#40;</span>instant-&gt;localDate-at-timezone
 <span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-04T00:00:00Z&quot;<span class="dim">&#41;</span> &quot;Pacific/Fiji&quot;<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
&#91;java.time.LocalDate 0x9fec931 &quot;2021-12-05&quot;&#93;
</code></pre><p>We wrap this up by writing a function to check a UTC instant and timezone against the date in that current time zone:</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>instant-today-at-tz?</strong> &#91;instant tz&#93;
  <span class="dim">&#40;</span>= <span class="dim">&#40;</span>-&gt;&gt; <span class="dim">&#40;</span>java.time.ZoneId/of tz<span class="dim">&#41;</span>
          <span class="dim">&#40;</span>.atZone &#94;java.time.Instant instant<span class="dim">&#41;</span>
          <span class="dim">&#40;</span>.toLocalDate<span class="dim">&#41;&#41;</span>
     <span class="dim">&#40;</span>java.time.LocalDate/now
      <span class="dim">&#40;</span>java.time.ZoneId/of tz<span class="dim">&#41;&#41;&#41;&#41;</span>
</code></pre><p>One last test:</p><pre><code class="Clojure"><span class="dim">&#40;</span>instant-today-at-tz?
 <span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-04T00:00:00Z&quot;<span class="dim">&#41;</span>
 &quot;Pacific/Fiji&quot;<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
false

<span class="dim">&#40;</span>instant-today-at-tz?
 <span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-04T23:00:00Z&quot;<span class="dim">&#41;</span>
 &quot;Pacific/Fiji&quot;<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
true

<span class="dim">&#40;</span>instant-today-at-tz?
 <span class="dim">&#40;</span>.toInstant #inst &quot;2021-12-05T00:00:00Z&quot;<span class="dim">&#41;</span>
 &quot;Pacific/Fiji&quot;<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
true
</code></pre><p>Everything is working as expected. We can now ensure our users get their daily digital advent content regardless of where they are in the world.</p></article><div class="footer"><p>Â© 2015-2024 Anders Murphy</p></div></div></body></html>