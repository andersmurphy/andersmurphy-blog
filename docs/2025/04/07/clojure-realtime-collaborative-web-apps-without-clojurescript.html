<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: Realtime collaborative web apps without ClojureScript</title><meta content="
base-uri        &apos;self&apos;;
form-action     &apos;self&apos;;
default-src     &apos;none&apos;;
script-src      &apos;self&apos;;
img-src         &apos;self&apos;;
font-src        &apos;self&apos;;
connect-src     &apos;self&apos;;
style-src       &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><script defer="defer" src="/toggle.js"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="same-origin" name="view-transition" /><meta content="A blog mostly about Clojure programming" name="description" /></head><body><header class="nav-sticky-top container-fluid"><nav class="container"><ul><li><div class="linkify" style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;">anders murphy</h1><a aria-label="Home" href="/"></a></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li><li><div class="theme-toggle" id="toggle"><svg aria-hidden="true" class="icon theme-toggle__inner-moon" height="30" viewBox="0 0 32 32" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M27.5 11.5v-7h-7L16 0l-4.5 4.5h-7v7L0 16l4.5 4.5v7h7L16 32l4.5-4.5h7v-7L32 16l-4.5-4.5zM16 25.4a9.39 9.39 0 1 1 0-18.8 9.39 9.39 0 1 1 0 18.8z"></path><circle cx="16" cy="16" r="8.1"></circle></svg></div></li></ul></nav></header><main class="container"><article><hgroup><h1>Clojure: Realtime collaborative web apps without ClojureScript</h1><p><time datetime="2025-04-07T00:00:00+00:00">07 Apr 2025</time></p></hgroup><hr /><p>Last week I made a fun little multiplayer web app. <a href='https://example.andersmurphy.com'>Go check it out here</a>.</p><p>... so you're back ...</p><p>That app had zero ClojureScript! What's even more wild is it had zero user written client side JS. Instead it uses <a href='https://data-star.dev'>Datastar</a>. A tiny 11.4kb (brotli compressed) hypermedia framework that lets you write reactive web apps with simple server side rendering.</p><p>This post is intended as a very quick introduction to some of the concepts and features of Datastar. So buckle up.</p><p><em>Note:  I've rolled my own opinionated Clojure mini framework that builds on Datastar called <a href='https://github.com/andersmurphy/hyperlith'>hyperlith</a>, but Datastar itself is both backend language and framework agnostic.</em></p><h2 id="the_same_model_as_react">The same model as React</h2><p>With Datastar you can still use the same <code>view = f &#40;state&#41;</code> model. The difference is  the <code>view</code> is on the client and <code>f &#40;state&#41;</code> stays on the server.</p><h2 id="show_me_the_code">Show me the code</h2><p>Lets start with a minimal shim, this is for the initial page load:</p><pre><code class="clojure"><span class="dim">&#40;</span>def <strong>default-shim-handler</strong>
  <span class="dim">&#40;</span>h/shim-handler
    <span class="dim">&#40;</span>h/html
      &#91;:link#css {:rel &quot;stylesheet&quot; :type &quot;text/css&quot; :href <span class="dim">&#40;</span>css :path<span class="dim">&#41;</span>}&#93;
      &#91;:title nil &quot;Game of Life&quot;&#93;
      &#91;:meta {:content &quot;Conway's Game of Life&quot; :name &quot;description&quot;}&#93;<span class="dim">&#41;&#41;&#41;</span>
</code></pre><p>Then we have a hiccup render function with a separate component <code>board-state</code> component:</p><pre><code class="clojure"><span class="dim">&#40;</span>def <strong>board-state</strong>
  <span class="dim">&#40;</span>h/cache
    <span class="dim">&#40;</span>fn &#91;db&#93;
      <span class="dim">&#40;</span>map-indexed
        <span class="dim">&#40;</span>fn &#91;id color-class&#93;
          <span class="dim">&#40;</span>h/html
            &#91;:div.tile
             {:class         color-class
              :id            id
              :data-on-click <span class="dim">&#40;</span>format &quot;@post<span class="dim">&#40;</span>'/tap?id=%s'<span class="dim">&#41;</span>&quot; id<span class="dim">&#41;</span>}&#93;<span class="dim">&#41;&#41;</span>
        <span class="dim">&#40;</span>:board @db<span class="dim">&#41;&#41;&#41;&#41;&#41;</span>
        
<span class="dim">&#40;</span>defn <strong>render-home</strong> &#91;{:keys &#91;db&#93; :as &#95;req}&#93;
  <span class="dim">&#40;</span>h/html
    &#91;:link#css {:rel &quot;stylesheet&quot; :type &quot;text/css&quot; :href <span class="dim">&#40;</span>css :path<span class="dim">&#41;</span>}&#93;
    &#91;:main#morph.main
     &#91;:h1 &quot;Game of Life <span class="dim">&#40;</span>multiplayer<span class="dim">&#41;</span>&quot;&#93;
     &#91;:div
      &#91;:div.board nil
       <span class="dim">&#40;</span>board-state db<span class="dim">&#41;</span>&#93;&#93;&#93;<span class="dim">&#41;&#41;</span>
</code></pre><p>A user action:</p><pre><code class="clojure"><span class="dim">&#40;</span>defn <strong>action-tap-cell</strong> &#91;{:keys &#91;sid db&#93; {:strs &#91;id&#93;} :query-params}&#93;
  <span class="dim">&#40;</span>swap! db fill-cross <span class="dim">&#40;</span>parse-long id<span class="dim">&#41;</span> sid<span class="dim">&#41;&#41;</span>
</code></pre><p>Some routes:</p><pre><code class="clojure"><span class="dim">&#40;</span>def <strong>router</strong>
  <span class="dim">&#40;</span>h/router
    {&#91;:get <span class="dim">&#40;</span>css :path<span class="dim">&#41;</span>&#93; <span class="dim">&#40;</span>css :handler<span class="dim">&#41;</span>
     &#91;:get  &quot;/&quot;&#93;        default-shim-handler
     &#91;:post &quot;/&quot;&#93;        <span class="dim">&#40;</span>h/render-handler #'render-home<span class="dim">&#41;</span>
     &#91;:post &quot;/tap&quot;&#93;     <span class="dim">&#40;</span>h/action-handler #'action-tap-cell<span class="dim">&#41;</span>}<span class="dim">&#41;&#41;</span>
</code></pre><p>We pass the <code>render-home</code> and <code>action-tap-cell</code> functions into some helper functions that build handlers and we are good to go.</p><h2 id="so_how_do_you_change_this_code_to_make_it_multiplayer%3F">So how do you change this code to make it multiplayer?</h2><p>That's the neat part you don't. It already is. The function we defined in <code>render-home</code> does not distinguish between users so everyone sees the same thing! If we wanted to render different views for different users, we would just generate user specific views in that function.</p><p>The function <code>action-tap-cell</code> does distinguish between users though. It picks a colour based on their <code>sid</code>.</p><p>If you've played around with <a href='https://github.com/hyperfiddle/electric'>Electric Clojure</a> you might find this familiar.</p><h2 id="this_code_is_declarative_%28and_naive%29">This code is declarative (and naive)</h2><p><img src="/assets/naive.png" alt="event listener image" /></p><p>There's no canvas here. There's no SVG. There's just a 1600 cell grid, each cell with it's own on-click listener. This is an incredibly naive implementation. Partly, to show how well it performs. Your CRUD app will be fine.</p><h2 id="but_what_about_the_network%3F">But what about the network?</h2><p>Brotli compression over SSE gives you 50-100:1 compression ratio over a series of backend re-renders. The compression is so good that in my experience it's more network efficient and more performant that fine grained updates with diffing (without any of the additional complexity). This approach avoids the additional challenges of view and session maintenance.</p><h2 id="conclusion">Conclusion</h2><p><a href='https://data-star.dev'>Datastar</a> pairs really well with Clojure and can make it trivial to implement highly interactive and collaborative web apps without ClojureScript. You should give it a go!</p><p>The full Datastar game of life source code can <a href='https://github.com/andersmurphy/hyperlith/blob/master/examples/game_of_life/src/app/main.clj'>be found here</a>.</p><p><strong>Further Reading:</strong></p><ul><li><a href='https://data-star.dev/guide/getting_started'>Datastar docs</a></li><li><a href='https://github.com/andersmurphy/hyperlith/tree/master/examples'>More hyperlith examples</a></li><li><a href='https://github.com/andersmurphy/hyperlith?tab=readme-ov-file#rational-more-like-a-collection-of-opinions'>More of my thoughts on using Datastar</a></li></ul></article><footer><p>Â© 2015-2025 Anders Murphy</p></footer></main></body></html>