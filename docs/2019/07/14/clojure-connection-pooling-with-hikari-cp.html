<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: connection pooling with hikari-cp</title><meta content="
base-uri        &apos;self&apos;;
form-action     &apos;self&apos;;
default-src     &apos;none&apos;;
script-src      &apos;self&apos;;
img-src         &apos;self&apos;;
font-src        &apos;self&apos;;
connect-src     &apos;self&apos;;
style-src       &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link data-turbo-track="reload" href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><script defer="defer" src="/toggle.js"></script><script defer="defer" src="/turbo.js" type="module"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="same-origin" name="view-transition" /><meta content="A blog mostly about programming." name="description" /></head><body><nav class="nav-sticky-top container-fluid"><ul><li><div class="linkify" style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;">anders murphy</h1><a href="/"></a></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li><li><div class="theme-toggle" id="toggle"><svg aria-hidden="true" class="icon theme-toggle__inner-moon" height="30" viewBox="0 0 32 32" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M27.5 11.5v-7h-7L16 0l-4.5 4.5h-7v7L0 16l4.5 4.5v7h7L16 32l4.5-4.5h7v-7L32 16l-4.5-4.5zM16 25.4a9.39 9.39 0 1 1 0-18.8 9.39 9.39 0 1 1 0 18.8z"></path><circle cx="16" cy="16" r="8.1"></circle></svg></div></li></ul></nav><main class="container"><article><hgroup><h1>Clojure: connection pooling with hikari-cp</h1><p><time datetime="2019-07-14T00:00:00+00:00">14 Jul 2019</time></p></hgroup><hr /><p>Connection pooling is a technique for improving app performance. A pool (cache) of reusable connections is maintained meaning when users connect to the database they can reuse an existing connection. When the user finishes using the connection it is placed back in the pool for other users to use. This reduces the overhead of connecting to the database by decreasing network traffic, limiting the cost of creating new connections, and reducing the load on the garbage collector. Effectively improving the responsiveness of your app for any task that requires connecting to the database.</p><p>This guide will use <a href='https://github.com/tomekw/hikari-cp'>hikari-cp</a> a Clojure wrapper around <a href='https://github.com/brettwooldridge/HikariCP'>HikariCP</a> a java database connection pooling library. It assumes you are using <a href='https://leiningen.org'>leiningen</a> as your build/dependency management tool and have a <a href='https://www.postgresql.org'>postgresql</a> database set up and running. It also won't cover using environment variables to store your database url out of source control (which is highly recommended for security).</p><h2 id="initial_set_up">Initial set up</h2><p>Start postgres.</p><pre><code class="bash">pg&#95;ctl -D pg start
</code></pre><p>Create a database called <code>databasename</code>.</p><pre><code class="bash">createdb databasename
</code></pre><h2 id="dependencies">Dependencies</h2><p>Add <code>org.clojure/java.jdbc</code>, <code>org.postgresql/postgresql</code> and <code>hikari-cp</code> to your dependencies.</p><pre><code class="clojure"><span class="dim">&#40;</span>defproject <strong>hikari-cp-example</strong> &quot;0.1.0-SNAPSHOT&quot;
  :dependencies &#91;&#91;org.clojure/clojure &quot;1.10.1&quot;&#93;
                 &#91;org.clojure/java.jdbc &quot;0.7.7&quot;&#93;
                 &#91;org.postgresql/postgresql &quot;42.2.3&quot;&#93;
                 &#91;hikari-cp &quot;2.7.1&quot;&#93;&#93;<span class="dim">&#41;</span>
</code></pre><h2 id="parsing_a_database_url">Parsing a database URL</h2><p>Create a helper function for passing urls.</p><pre><code class="clojure"><span class="dim">&#40;</span>ns <strong>hikari-cp-example.core</strong>
  <span class="dim">&#40;</span>:require &#91;clojure.java.jdbc :as sql&#93;
            &#91;hikari-cp.core :as cp&#93;
            &#91;clojure.string :as str&#93;<span class="dim">&#41;&#41;</span>

<span class="dim">&#40;</span>defn <strong>db-info-from-url</strong> &#91;db-url&#93;
  <span class="dim">&#40;</span>let &#91;db-uri              <span class="dim">&#40;</span>java.net.URI. db-url<span class="dim">&#41;</span>
        &#91;username password&#93; <span class="dim">&#40;</span>str/split <span class="dim">&#40;</span>or <span class="dim">&#40;</span>.getUserInfo db-uri<span class="dim">&#41;</span> &quot;:&quot;<span class="dim">&#41;</span> #&quot;:&quot;<span class="dim">&#41;</span>&#93;
    {:username      <span class="dim">&#40;</span>or username <span class="dim">&#40;</span>System/getProperty &quot;user.name&quot;<span class="dim">&#41;&#41;</span>
     :password      <span class="dim">&#40;</span>or password &quot;&quot;<span class="dim">&#41;</span>
     :port-number   <span class="dim">&#40;</span>.getPort db-uri<span class="dim">&#41;</span>
     :database-name <span class="dim">&#40;</span>str/replace-first <span class="dim">&#40;</span>.getPath db-uri<span class="dim">&#41;</span> &quot;/&quot; &quot;&quot;<span class="dim">&#41;</span>
     :server-name   <span class="dim">&#40;</span>.getHost db-uri<span class="dim">&#41;</span>}<span class="dim">&#41;&#41;</span>

</code></pre><p>This function parses urls that are of the form <code>postgresql://username:password@localhost:5432/databasename&quot;</code>. It also handles defaults if certain parameters are missing.</p><h2 id="setting_up_the_connection_pool">Setting up the connection pool</h2><p>Define the connection.</p><pre><code class="clojure"><span class="dim">&#40;</span>def <strong>datasource-options</strong>
  <span class="dim">&#40;</span>merge <span class="dim">&#40;</span>db-info-from-url &quot;postgresql://localhost:5432/databasename&quot;<span class="dim">&#41;</span>
         {:auto-commit        true
          :read-only          false
          :adapter            &quot;postgresql&quot;
          :connection-timeout 30000
          :validation-timeout 5000
          :idle-timeout       600000
          :max-lifetime       1800000
          :minimum-idle       10
          :maximum-pool-size  20
          :pool-name          &quot;db-pool&quot;
          :register-mbeans    false}<span class="dim">&#41;&#41;</span>
</code></pre><p>Define a connection creating function using <code>defonce</code> to ensure it is only create once and <code>delay</code> to make it lazy.</p><pre><code class="clojure"><span class="dim">&#40;</span>defonce <strong>datasource</strong>
  <span class="dim">&#40;</span>delay <span class="dim">&#40;</span>cp/make-datasource datasource-options<span class="dim">&#41;&#41;&#41;</span>
</code></pre><p>Create the connection.</p><pre><code class="clojure"><span class="dim">&#40;</span>def <strong>database-connection</strong> {:datasource @datasource}<span class="dim">&#41;</span>
</code></pre><p>You should see some logs from hikari start to flood the repl.</p><pre><code class="clojure"><span class="dim">...</span>
16:28:58.495 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; DEBUG com.zaxxer.hikari.HikariConfig - schema<span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span>..none
16:28:58.495 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; DEBUG com.zaxxer.hikari.HikariConfig - threadFactory<span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span>.internal
16:28:58.495 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; DEBUG com.zaxxer.hikari.HikariConfig - transactionIsolation<span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span>default
16:28:58.495 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; DEBUG com.zaxxer.hikari.HikariConfig - username<span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span>&quot;anders&quot;
16:28:58.495 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; DEBUG com.zaxxer.hikari.HikariConfig - validationTimeout<span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span><span class="dim">...</span>5000
16:28:58.497 &#91;nRepl-session-7849a8f5-c0c2-4a6e-99f7-af9c375c9653&#93; INFO com.zaxxer.hikari.HikariDataSource - db-pool - Starting<span class="dim">...</span>
<span class="dim">...</span>
</code></pre><h2 id="stop_the_logs_flooding_the_repl">Stop the logs flooding the repl</h2><p>The hikari logs can be quite noisy. Logback can be used to filter out the DEBUG and INFO level messages.</p><p>Add logback as a dependency.</p><pre><code class="clojure"><span class="dim">&#40;</span>defproject <strong>hikari-cp-example</strong> &quot;0.1.0-SNAPSHOT&quot;
  :dependencies &#91;&#91;org.clojure/clojure &quot;1.10.0&quot;&#93;
                 &#91;org.clojure/java.jdbc &quot;0.7.7&quot;&#93;
                 &#91;org.postgresql/postgresql &quot;42.2.3&quot;&#93;
                 &#91;hikari-cp &quot;2.7.1&quot;&#93;
                 &#91;ch.qos.logback/logback-classic &quot;1.2.3&quot;&#93;&#93;<span class="dim">&#41;</span>
</code></pre><p>Create a <code>logback.xml</code> in your project <code>resources</code> folder (lein will add this to the class path).</p><pre><code class="xml">&lt;configuration debug=&quot;false&quot;&gt;
 &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %-10contextName %logger{36} - %msg%n&lt;/pattern&gt;
    &lt;/encoder&gt;
 &lt;/appender&gt;
 &lt;logger name=&quot;com.zaxxer.hikari&quot;&gt;
     &lt;level value=&quot;error&quot;/&gt;
 &lt;/logger&gt;
  &lt;root level=&quot;INFO&quot;&gt;
    &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
  &lt;/root&gt;
&lt;/configuration&gt;
</code></pre><p>Now only ERROR level hikari messages will be logged.</p><p>This concludes this guide to setting up connection pooling with hikari-cp. The full example <a href='https://github.com/andersmurphy/clj-cookbook/tree/master/connection-pooling/hikari-cp-example'>project can be found here</a>.</p><p>For a <a href='https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing'>detailed explanation on what the pool size should be check out this post</a>.</p></article><footer><p>© 2015-2024 Anders Murphy</p></footer></main></body></html>