<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: removing namespace from keywords in response middleware</title><meta content="
base-uri        &apos;self&apos;;
form-action     &apos;self&apos;;
default-src     &apos;none&apos;;
script-src      &apos;self&apos;;
img-src         &apos;self&apos;;
font-src        &apos;self&apos;;
connect-src     &apos;self&apos;;
style-src       &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link data-turbo-track="reload" href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><script defer="defer" src="/toggle.js"></script><script defer="defer" src="/turbo.js" type="module"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="same-origin" name="view-transition" /><meta content="A blog mostly about programming." name="description" /></head><body><header class="nav-sticky-top container-fluid"><nav class="container"><ul><li><div class="linkify" style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;">anders murphy</h1><a aria-label="Home" href="/"></a></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li><li><div class="theme-toggle" id="toggle"><svg aria-hidden="true" class="icon theme-toggle__inner-moon" height="30" viewBox="0 0 32 32" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M27.5 11.5v-7h-7L16 0l-4.5 4.5h-7v7L0 16l4.5 4.5v7h7L16 32l4.5-4.5h7v-7L32 16l-4.5-4.5zM16 25.4a9.39 9.39 0 1 1 0-18.8 9.39 9.39 0 1 1 0 18.8z"></path><circle cx="16" cy="16" r="8.1"></circle></svg></div></li></ul></nav></header><main class="container"><article><hgroup><h1>Clojure: removing namespace from keywords in response middleware</h1><p><time datetime="2022-03-27T00:00:00+00:00">27 Mar 2022</time></p></hgroup><hr /><p>Namespaced keywords let you add a namespace to a keyword <code>:id</code> -> <code>:user/id</code>, this is a really nice feature that prevents collisions when merging two maps. For example merging  <code>{:account/id &quot;foo&quot;}</code> with  <code>{:user/id &quot;bar&quot;}&#41;</code> would give you <code>{:account/id &quot;foo&quot; :user/id &quot;bar&quot;}</code>. This lets you avoid unnecessary data nesting and keep your data flat. However, by the time this data gets to the edge of your system, where it meets something that expects json, you will often want to remove these namespaces. This post shows you how to write a middleware that automates the removal of namespaces from keywords.</p><p>We can remove the namespace from a keyword with the following code.</p><pre><code class="clojure"><span class="dim">&#40;</span>-&gt; :foo/bar name keyword<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
:bar
</code></pre><p>To remove all namespaces in an arbitrarily nested piece of data we can use <code>clojure.walk/postwalk</code>.</p><pre><code class="clojure"><span class="dim">&#40;</span>defn <strong>transform-keys</strong>
  &#91;t coll&#93;
  <span class="dim">&#40;</span>clojure.walk/postwalk <span class="dim">&#40;</span>fn &#91;x&#93; <span class="dim">&#40;</span>if <span class="dim">&#40;</span>map? x<span class="dim">&#41;</span> <span class="dim">&#40;</span>update-keys x t<span class="dim">&#41;</span> x<span class="dim">&#41;&#41;</span> coll<span class="dim">&#41;&#41;</span>
</code></pre><p>As of Clojure as of <code>1.11.0</code> we can now use  <code>update-keys</code> (without having to roll our own implementation).</p><p>Now for the middleware. Ring defines middleware as a function of type <code>handler &amp; args =&gt; request =&gt; response</code>.</p><pre><code class="clojure"><span class="dim">&#40;</span>defn <strong>remove-namespace-keywords-in-response-middleware</strong> &#91;handler &amp; &#95;&#93;
  <span class="dim">&#40;</span>fn &#91;req&#93;
    <span class="dim">&#40;</span>let &#91;resp <span class="dim">&#40;</span>handler req<span class="dim">&#41;</span>&#93;
      <span class="dim">&#40;</span>cond-&gt; resp
        <span class="dim">&#40;</span>comp map? :body<span class="dim">&#41;</span> <span class="dim">&#40;</span>update :body
                                  <span class="dim">&#40;</span>partial transform-keys
                                           <span class="dim">&#40;</span>comp keyword name<span class="dim">&#41;&#41;&#41;&#41;&#41;&#41;&#41;</span>
</code></pre><p><code>cond-&gt;</code> is a nice way to conditionally do some things to a map (unlike <code>cond</code>, <code>cond-&gt;</code> doesn't short circuit after the first true expression). The <code>cond-&gt;</code> macro is really useful for conditional operations on data. In this case we only want to remove namespaces if the response has a body.</p><p>Thanks to this middleware we no longer have to remember to remove namespaces form keywords when returning json responses form our API.</p><p>Something to point out with this implementation, is that if the keywords without namespaces are not unique they will get overwritten. This normally isn't an problem as by the time you are structuring your data for a json response it will be nested, but it's still worth bearing in mind.</p><pre><code class="clojure"><span class="dim">&#40;</span>update-keys
  {:user/id &quot;foo&quot; :accont/id &quot;bar&quot;}
  <span class="dim">&#40;</span>comp keyword name<span class="dim">&#41;&#41;</span>
<span class="dim">
=&gt;</span> {:id &quot;bar&quot;}
</code></pre></article><footer><p>Â© 2015-2024 Anders Murphy</p></footer></main></body></html>