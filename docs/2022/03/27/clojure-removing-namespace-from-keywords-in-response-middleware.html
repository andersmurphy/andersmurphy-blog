<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: removing namespace from keywords in response middleware</title><meta content="
base-uri    &apos;self&apos;;
form-action &apos;self&apos;;
default-src &apos;none&apos;;
script-src  &apos;self&apos;;
img-src     &apos;self&apos;;
font-src    &apos;self&apos;;
connect-src &apos;self&apos;;
style-src   &apos;self&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144" /><link href="/assets/favicon.ico" rel="shortcut icon" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="A blog mostly about software development." name="description" /></head><body><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><img alt="portrait" class="portrait" height="120" src="/assets/anderspixel.png" width="60" /><h1><a href="/">Anders Murphy</a></h1><p class="lead">A blog mostly about functional programming</p></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="https://github.com/andersmurphy">Github</a><a class="sidebar-nav-item" href="https://twitter.com/anders_murphy">Twitter</a><a class="sidebar-nav-item" href="https://uk.linkedin.com/in/anders-murphy-76457b3a">LinkedIn</a><a class="sidebar-nav-item" href="/feed.xml">RSS</a></nav></div></div><div class="content container"><article class="post"><h1 class="post-title">Clojure: removing namespace from keywords in response middleware</h1><time class="post-date" datetime="2022-03-27T00:00:00+00:00">27 Mar 2022</time><p>Namespaced keywords let you add a namespace to a keyword <code>:id</code> -> <code>:user/id</code>, this is a really nice feature that prevents collisions when merging two maps. For example merging  <code>{:account/id &quot;foo&quot;}</code> with  <code>{:user/id &quot;bar&quot;}&#41;</code> would give you <code>{:account/id &quot;foo&quot; :user/id &quot;bar&quot;}</code>. This lets you avoid unnecessary data nesting and keep your data flat. However, by the time this data gets to the edge of your system, where it meets something that expects json, you will often want to remove these namespaces. This post shows you how to write a middleware that automates the removal of namespaces from keywords.</p><p>We can remove the namespace from a keyword with the following code.</p><pre><code class="clojure"><span class="dim">&#40;</span>-&gt; :foo/bar name keyword<span class="dim">&#41;</span>
<span class="dim">
=&gt;</span>
:bar
</code></pre><p>To remove all namespaces in an arbitrarily nested piece of data we can use <code>clojure.walk/postwalk</code>.</p><pre><code class="clojure"><span class="dim">&#40;</span>defn <strong>transform-keys</strong>
  &#91;t coll&#93;
  <span class="dim">&#40;</span>clojure.walk/postwalk <span class="dim">&#40;</span>fn &#91;x&#93; <span class="dim">&#40;</span>if <span class="dim">&#40;</span>map? x<span class="dim">&#41;</span> <span class="dim">&#40;</span>update-keys x t<span class="dim">&#41;</span> x<span class="dim">&#41;&#41;</span> coll<span class="dim">&#41;&#41;</span>
</code></pre><p>As of Clojure as of <code>1.11.0</code> we can now use  <code>update-keys</code> (without having to roll our own implementation).</p><p>Now for the middleware. Ring defines middleware as a function of type <code>handler &amp; args =&gt; request =&gt; response</code>.</p><pre><code class="clojure"><span class="dim">&#40;</span>defn <strong>remove-namespace-keywords-in-response-middleware</strong> &#91;handler &amp; &#95;&#93;
  <span class="dim">&#40;</span>fn &#91;req&#93;
    <span class="dim">&#40;</span>let &#91;resp <span class="dim">&#40;</span>handler req<span class="dim">&#41;</span>&#93;
      <span class="dim">&#40;</span>cond-&gt; resp
        <span class="dim">&#40;</span>comp map? :body<span class="dim">&#41;</span> <span class="dim">&#40;</span>update :body
                                  <span class="dim">&#40;</span>partial transform-keys
                                           <span class="dim">&#40;</span>comp keyword name<span class="dim">&#41;&#41;&#41;&#41;&#41;&#41;&#41;</span>
</code></pre><p><code>cond-&gt;</code> is a nice way to conditionally do some things to a map (unlike <code>cond</code>, <code>cond-&gt;</code> doesn't short circuit after the first true expression). The <code>cond-&gt;</code> macro is really useful for conditional operations on data. In this case we only want to remove namespaces if the response has a body.</p><p>Thanks to this middleware we no longer have to remember to remove namespaces form keywords when returning json responses form our API.</p><p>Something to point out with this implementation, is that if the keywords without namespaces are not unique they will get overwritten. This normally isn't an problem as by the time you are structuring your data for a json response it will be nested, but it's still worth bearing in mind.</p><pre><code class="clojure"><span class="dim">&#40;</span>update-keys
  {:user/id &quot;foo&quot; :accont/id &quot;bar&quot;}
  <span class="dim">&#40;</span>comp keyword name<span class="dim">&#41;&#41;</span>
<span class="dim">
=&gt;</span> {:id &quot;bar&quot;}
</code></pre></article><div class="footer"><p>Â© 2015-2024 Anders Murphy</p></div></div></body></html>