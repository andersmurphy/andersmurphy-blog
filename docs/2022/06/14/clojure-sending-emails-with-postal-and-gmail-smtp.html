<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: sending emails with postal and Gmail SMTP</title><meta content="
base-uri    &apos;self&apos;;
form-action &apos;self&apos;;
default-src &apos;none&apos;;
script-src  &apos;self&apos;;
img-src     &apos;self&apos;;
font-src    &apos;self&apos;;
connect-src &apos;self&apos;;
style-src   &apos;self&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144" /><link href="/assets/favicon.ico" rel="shortcut icon" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="A blog mostly about software development." name="description" /></head><body><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><img alt="portrait" class="portrait" height="120" src="/assets/anderspixel.png" width="60" /><h1><a href="/">Anders Murphy</a></h1><p class="lead">A blog mostly about functional programming</p></div><nav class="sidebar-nav"><a class="sidebar-nav-item" href="https://github.com/andersmurphy">Github</a><a class="sidebar-nav-item" href="https://twitter.com/anders_murphy">Twitter</a><a class="sidebar-nav-item" href="https://uk.linkedin.com/in/anders-murphy-76457b3a">LinkedIn</a><a class="sidebar-nav-item" href="/feed.xml">RSS</a></nav></div></div><div class="content container"><article class="post"><h1 class="post-title">Clojure: sending emails with postal and Gmail SMTP</h1><time class="post-date" datetime="2022-06-14T00:00:00+00:00">14 Jun 2022</time><p>While services like <a href='https://sendgrid.com'>SendGrid</a> are easy to use and offer a plethora of features like bounce and open rate monitoring, they are not the cheapest option. Gmail's SMTP service on the other hand, although not as feature rich, is more affordable. In this post we will cover setting up Gmail SMTP with <a href='https://github.com/drewr/postal'>postal</a>.</p><h2 id="limits_for_sending_mail">Limits for sending mail</h2><p>These are the Gmail per user sending limits:</p><table><thead><tr><th style='text-align:left'>Account Type</th><th style='text-align:right'>messages/rolling 24 hours</th></tr></thead><tbody><tr><td style='text-align:left'>Standard Gmail</td><td style='text-align:right'>500</td></tr><tr><td style='text-align:left'>Google Workspace</td><td style='text-align:right'>2000</td></tr><tr><td style='text-align:left'>Google Workspace SMTP relay</td><td style='text-align:right'>10000</td></tr></tbody></table><h2 id="cost">Cost</h2><p>At the time of writing SendGrid's price point for 200 000 emails a month is $89.95/mo. Comparatively, to send 10000 per day with Gmail is free if you are already using google workspace, and chances are you do for your company email address. Even if you don't a single seat account is just under 5$ a month and comes with a host of other utilities.</p><h2 id="setting_up_gmail">Setting up Gmail</h2><p>First we need to make sure our Gmail account has 2-step verification set up. Then we need to create an app password. To do this go to Google account settings and navigate to the "Security" tab. Under "Signing in to Google", click on the "App passwords" menu item. Select Other under the "Select app" dropdown and enter the name of the app. Click "Generate" and the new app password will appear on the screen. Copy the password somewhere as we will be needing it later.</p><h2 id="setting_up_google_workspace_smpt_%28optional%29">Setting up Google Workspace SMPT (Optional)</h2><p><a href='https://support.google.com/a/answer/2956491'>Follow these steps</a> if you want to set up Google Workspace Relay. This is only necessary if you plan on sending more than 2000 messages/rolling 24 hours.</p><h2 id="postal">Postal</h2><p><a href='https://github.com/drewr/postal'>postal</a> is a library for constructing and sending RFC822-compliant Internet email messages via SMTP.</p><p>To send email with postal we need to call the <code>send-message</code> function. The <code>:host</code> is set to <code>&quot;smtp.gmail.com&quot;</code> (if you are using workspace SMTP relay set it to <code>&quot;smtp-relay.gmail.com&quot;</code>), <code>:port</code> to <code>587</code>, <code>:tls</code> to <code>true</code>, <code>:user</code> to your Gmail address and <code>pass</code> to the app password created in the previous step.</p><pre><code class="clojure"><span class="dim">&#40;</span>require '&#91;postal.core :refer &#91;send-message&#93;&#93;<span class="dim">&#41;</span>

<span class="dim">&#40;</span>send-message
 {:host &quot;smtp.gmail.com&quot;
  :user &quot;your@gmail.com&quot;
  :pass &quot;your-gmail-app-password&quot;
  :port 587
  :tls  true}
 {:from    &quot;foo@gmail.com&quot;
  :to      &#91;&quot;bar@mail.com&quot;
            &quot;baz@mail.com&quot;&#93;
  :subject &quot;You got mail!&quot;
  :body    &quot;Hello!&quot;}<span class="dim">&#41;</span>
</code></pre><p>For security best practice you will want to pass the values of  <code>:user</code> and <code>:pass</code> through environment variables rather than hard code them:</p><pre><code class="clojure"><span class="dim">&#40;</span>send-message
 {:host &quot;smtp.gmail.com&quot;
  :user <span class="dim">&#40;</span>System/getenv &quot;EMAIL&#95;USER&quot;<span class="dim">&#41;</span>
  :pass <span class="dim">&#40;</span>System/getenv &quot;EMAIL&#95;PASS&quot;<span class="dim">&#41;</span>
  :port 587
  :tls  true}
 {<span class="dim">;; Gets re-written by google to user email
</span>  :from    &quot;foo@gmail.com&quot;
  :to      &#91;&quot;bar@mail.com&quot;
            &quot;baz@mail.com&quot;&#93;
  :subject &quot;You got mail!&quot;
  :body    &quot;Hello!&quot;}<span class="dim">&#41;</span>
</code></pre><p>You can now send email via Gmail from your Clojure backend.</p><p><em>Note 1:  One of the downsides with Gmail SMTP is it doesn't let you overwrite the from field. Meaning the message will always show as being delivered from the email address that send the message. This might make it unsuitable for your use case, so bear that in mind.</em></p><p><em>Note 2: <a href='https://sendgrid.com'>SendGrid</a> is still a fantastic service, and I would still recommend it if you need more advanced monitoring and other advanced features.</em></p><p><em>Note 3: Since <a href='https://aws.amazon.com/ses/'>Amazon SES</a> uses SMTP you can also use postal to send emails through SES instead of Gmail.</em></p></article><div class="footer"><p>Â© 2015-2024 Anders Murphy</p></div></div></body></html>