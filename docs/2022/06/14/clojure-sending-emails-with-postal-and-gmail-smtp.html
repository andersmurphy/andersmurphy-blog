<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><title>Clojure: sending emails with postal and Gmail SMTP</title><meta content="
base-uri        &apos;self&apos;;
form-action     &apos;self&apos;;
default-src     &apos;none&apos;;
script-src      &apos;self&apos;;
img-src         &apos;self&apos;;
font-src        &apos;self&apos;;
connect-src     &apos;self&apos;;
frame-src       https://example.andersmurphy.com;
style-src       &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><script defer="defer" src="/toggle.js"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="same-origin" name="view-transition" /><meta content="A blog mostly about Clojure programming" name="description" /></head><body><header class="nav-sticky-top container-fluid"><nav class="container"><ul><li><div class="linkify" style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;">anders murphy</h1><a aria-label="Home" href="/"></a></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" style="margin-bottom:6px;margin-top:6px;" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li><li><div class="theme-toggle" id="toggle"><svg aria-hidden="true" class="icon theme-toggle__inner-moon" height="30" viewBox="0 0 32 32" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M27.5 11.5v-7h-7L16 0l-4.5 4.5h-7v7L0 16l4.5 4.5v7h7L16 32l4.5-4.5h7v-7L32 16l-4.5-4.5zM16 25.4a9.39 9.39 0 1 1 0-18.8 9.39 9.39 0 1 1 0 18.8z"></path><circle cx="16" cy="16" r="8.1"></circle></svg></div></li></ul></nav></header><main class="container"><article><hgroup><h1>Clojure: sending emails with postal and Gmail SMTP</h1><p><time datetime="2022-06-14T00:00:00+00:00">14 Jun 2022</time></p></hgroup><hr /><p>While services like <a href='https://sendgrid.com'>SendGrid</a> are easy to use and offer a plethora of features like bounce and open rate monitoring, they are not the cheapest option. Gmail's SMTP service on the other hand, although not as feature rich, is more affordable. In this post we will cover setting up Gmail SMTP with <a href='https://github.com/drewr/postal'>postal</a>.</p><h2 id="limits_for_sending_mail">Limits for sending mail</h2><p>These are the Gmail per user sending limits:</p><table><thead><tr><th style='text-align:left'>Account Type</th><th style='text-align:right'>messages/rolling 24 hours</th></tr></thead><tbody><tr><td style='text-align:left'>Standard Gmail</td><td style='text-align:right'>500</td></tr><tr><td style='text-align:left'>Google Workspace</td><td style='text-align:right'>2000</td></tr><tr><td style='text-align:left'>Google Workspace SMTP relay</td><td style='text-align:right'>10000</td></tr></tbody></table><h2 id="cost">Cost</h2><p>At the time of writing SendGrid's price point for 200 000 emails a month is $89.95/mo. Comparatively, to send 10000 per day with Gmail is free if you are already using google workspace, and chances are you do for your company email address. Even if you don't a single seat account is just under 5$ a month and comes with a host of other utilities.</p><h2 id="setting_up_gmail">Setting up Gmail</h2><p>First we need to make sure our Gmail account has 2-step verification set up. Then we need to create an app password. To do this go to Google account settings and navigate to the "Security" tab. Under "Signing in to Google", click on the "App passwords" menu item (if it's not there you can <a href='https://myaccount.google.com/apppasswords'>access it through this link</a>). Select Other under the "Select app" dropdown and enter the name of the app. Click "Generate" and the new app password will appear on the screen. Copy the password somewhere as we will be needing it later.</p><h2 id="setting_up_google_workspace_smpt_%28optional%29">Setting up Google Workspace SMPT (Optional)</h2><p><a href='https://support.google.com/a/answer/2956491'>Follow these steps</a> if you want to set up Google Workspace Relay. This is only necessary if you plan on sending more than 2000 messages/rolling 24 hours.</p><h2 id="postal">Postal</h2><p><a href='https://github.com/drewr/postal'>postal</a> is a library for constructing and sending RFC822-compliant Internet email messages via SMTP.</p><p>To send email with postal we need to call the <code>send-message</code> function. The <code>:host</code> is set to <code>&quot;smtp.gmail.com&quot;</code> (if you are using workspace SMTP relay set it to <code>&quot;smtp-relay.gmail.com&quot;</code>), <code>:port</code> to <code>587</code>, <code>:tls</code> to <code>true</code>, <code>:user</code> to your Gmail address and <code>pass</code> to the app password created in the previous step.</p><pre><code class="clojure"><span class="dim">&#40;</span>require '&#91;postal.core :refer &#91;send-message&#93;&#93;<span class="dim">&#41;</span>

<span class="dim">&#40;</span>send-message
 {:host &quot;smtp.gmail.com&quot;
  :user &quot;your@gmail.com&quot;
  :pass &quot;your-gmail-app-password&quot;
  :port 587
  :tls  true}
 {:from    &quot;foo@gmail.com&quot;
  :to      &#91;&quot;bar@mail.com&quot;
            &quot;baz@mail.com&quot;&#93;
  :subject &quot;You got mail!&quot;
  :body    &quot;Hello!&quot;}<span class="dim">&#41;</span>
</code></pre><p>For security best practice you will want to pass the values of  <code>:user</code> and <code>:pass</code> through environment variables rather than hard code them:</p><pre><code class="clojure"><span class="dim">&#40;</span>send-message
 {:host &quot;smtp.gmail.com&quot;
  :user <span class="dim">&#40;</span>System/getenv &quot;EMAIL&#95;USER&quot;<span class="dim">&#41;</span>
  :pass <span class="dim">&#40;</span>System/getenv &quot;EMAIL&#95;PASS&quot;<span class="dim">&#41;</span>
  :port 587
  :tls  true}
 {<span class="dim">;; Gets re-written by google to user email
</span>  :from    &quot;foo@gmail.com&quot;
  :to      &#91;&quot;bar@mail.com&quot;
            &quot;baz@mail.com&quot;&#93;
  :subject &quot;You got mail!&quot;
  :body    &quot;Hello!&quot;}<span class="dim">&#41;</span>
</code></pre><p>You can now send email via Gmail from your Clojure backend.</p><p><em>Note 1:  One of the downsides with Gmail SMTP is it doesn't let you overwrite the from field. Meaning the message will always show as being delivered from the email address that send the message. This might make it unsuitable for your use case, so bear that in mind.</em></p><p><em>Note 2: <a href='https://sendgrid.com'>SendGrid</a> is still a fantastic service, and I would still recommend it if you need more advanced monitoring and other advanced features.</em></p><p><em>Note 3: Since <a href='https://aws.amazon.com/ses/'>Amazon SES</a> uses SMTP you can also use postal to send emails through SES instead of Gmail.</em></p></article><footer><p>Â© 2015-2025 Anders Murphy</p></footer></main></body></html>