<!DOCTYPE html>
<html data-theme="dark" lang="en"><head><meta charset="UTF-8" /><title>Clojure: SQLite application defined SQL functions with JDBC</title><meta content="
base-uri    &apos;self&apos;;
form-action &apos;self&apos;;
default-src &apos;none&apos;;
script-src  &apos;self&apos;;
img-src     &apos;self&apos;;
font-src    &apos;self&apos;;
connect-src &apos;self&apos;;
style-src   &apos;self&apos; &apos;unsafe-inline&apos;
" http-equiv="Content-Security-Policy" /><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><link href="/styles.css" rel="stylesheet" type="text/css" /><link href="/assets/favicon.png" rel="shortcut icon" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="A blog mostly about software development." name="description" /></head><body><nav class="container"><ul><li><div style="align-items:center;display:flex;"><img alt="portrait" height="40px" src="/assets/avatar.png" style="image-rendering:pixelated;padding:4px;" width="40px" /><h1 style="margin-bottom:0;"><a class="contrast" href="/">anders murphy</a></h1></div></li></ul><ul><li><a aria-label="Github" class="contrast no-chaos" href="https://github.com/andersmurphy"><svg class="icon" height="24" viewBox="0 0 496 512" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a aria-label="RSS" class="contrast no-chaos" href="/feed.xml"><svg class="icon" height="24" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><linearGradient id="gradient-horizontal"><stop offset="0%" stop-color="var(--color-stop-1)"></stop><stop offset="33%" stop-color="var(--color-stop-2)"></stop><stop offset="66%" stop-color="var(--color-stop-3)"></stop><stop offset="100%" stop-color="var(--color-stop-4)"></stop></linearGradient><path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path></svg></a></li></ul></nav><div class="container"><article><hgroup><h1>Clojure: SQLite application defined SQL functions with JDBC</h1><p><time datetime="2023-07-16T00:00:00+00:00">16 Jul 2023</time></p></hgroup><hr /><p>SQLite provides a convenient interface called <a href='https://www.sqlite.org/appfunc.html'>Application-Defined SQL Functions</a> that lets you create custom SQL functions that call back into your application code to compute their results. This lets us  extend SQLite in Clojure. Want to query with regex or jsonpath? Want custom aggregation functions? Don't want to write C? Don't want to manage different precompiled binaries for different operating systems. No problem Application Defined SQL Functions have you covered. </p><h2 id="in_java">In Java</h2><p> <a href='https://github.com/xerial/sqlite-jdbc'>org.sqlite</a> provides an abstract class <code>org.sqlite.Function</code> for implementing application defined  SQL functions.</p><p>Bellow is how <code>org.sqlite.Function</code> is intended to be used from java using an anonymous class that extends <code>org.sqlite.Function</code>.</p><pre><code class="java">Function.create&#40;conn, &quot;hello&#95;world&quot;, new Function&#40;&#41; {
 @Override
 protected void xFunc&#40;&#41; {
   result&#40;&quot;Hello, world!&quot;&#41;
 }
}, 0, Function.FLAG&#95;DETERMINISTIC&#41;;
</code></pre><h2 id="in_clojure">In Clojure</h2><p>Clojure provides the <code>proxy</code> function for creating anonymous classes. However, it doesn't allow you to access protected super methods, and unfortunately <code>org.sqlite.Function</code>  implements a bunch of methods as protected. So we will need to use the <code>gen-class</code> macro.</p><h3 id="create_a_gen-class">Create a gen-class</h3><p><code>gen-class</code> creates named classes for direct use as Java classes and allows us to expose inherited protected methods.</p><pre><code class="Clojure"><span class="dim">&#40;</span>gen-class
  :name sqlite.db.application-defined-functions.RegexCapture
  :prefix &quot;regex-capture-&quot;
  :extends org.sqlite.Function
  :exposes-methods {result superResult
                    value&#95;text superValueText}<span class="dim">&#41;</span>
</code></pre><p>We extend <code>org.sqlite.Function</code> and expose the methods <code>result</code> and <code>value&#95;text</code> binding them to <code>superResult</code> and <code>superValueText</code> respectively.</p><h3 id="override_xfunc">Override xFunc</h3><p>We use <code>defn</code> to override the <code>org.sqlite.Function</code> class's <code>xFunc</code> method. It's important to note that the function name prefix must match the prefix specified in <code>gen-class</code> under <code>:prefix</code>. In this case that's <code>regex-capture-</code>.</p><pre><code class="Clojure"><span class="dim">&#40;</span>defn <strong>regex-capture-xFunc</strong> &#91;this&#93;
  <span class="dim">&#40;</span>.superResult this
    <span class="dim">&#40;</span>let &#91;result <span class="dim">&#40;</span>re-find
                   <span class="dim">&#40;</span>re-pattern
                     <span class="dim">&#40;</span>.superValueText  this 0<span class="dim">&#41;&#41;</span>
                   <span class="dim">&#40;</span>.superValueText  this 1<span class="dim">&#41;&#41;</span>&#93;
      <span class="dim">&#40;</span>if <span class="dim">&#40;</span>vector? result<span class="dim">&#41;</span>
        <span class="dim">&#40;</span>second result<span class="dim">&#41;</span>
        result<span class="dim">&#41;&#41;&#41;&#41;</span>
</code></pre><h3 id="create_a_directory_called_classes">Create a directory called classes</h3><p>Ensure the default target output directory <code>classes</code> exists at the top level of the project.</p><h3 id="add_classes_directory_to_paths">Add classes directory to paths</h3><p>Add the classes directory to the class path in <code>deps.edn</code>.</p><pre><code class="Clojure">{:paths   &#91;&quot;src&quot; &quot;classes&quot;&#93;
 :deps
 {org.clojure/clojure               {:mvn/version &quot;1.11.1&quot;}
  com.github.seancorfield/next.jdbc {:mvn/version &quot;1.3.874&quot;}
  org.xerial/sqlite-jdbc            {:mvn/version &quot;3.42.0.0&quot;}}
 :aliases {}}
</code></pre><h3 id="generate_the_classes">Generate the classes</h3><p>Compile to generate classes using the <code>compile</code> function.</p><pre><code class="clojure"><span class="dim">&#40;</span>compile 'sqlite.db.application-defined-functions<span class="dim">&#41;</span>
</code></pre><h3 id="tests_the_sql_functions">Tests the SQL functions</h3><p>To use the application defined SQL functions we need to create them. This loads them into SQLite for the duration of the current connection, meaning they can be used in any query that uses the same connection.</p><pre><code class="Clojure"><span class="dim">&#40;</span>let &#91;my-datasource <span class="dim">&#40;</span>jdbc/get-datasource
                      {:jdbcUrl &quot;jdbc:sqlite:db/database.db&quot;}<span class="dim">&#41;</span>&#93;
  <span class="dim">&#40;</span>with-open &#91;conn <span class="dim">&#40;</span>jdbc/get-connection my-datasource<span class="dim">&#41;</span>&#93;
    <span class="dim">&#40;</span>Function/create
      conn
      &quot;regex&#95;capture&quot;
      <span class="dim">&#40;</span>sqlite.db.application-defined-functions.RegexCapture.<span class="dim">&#41;&#41;</span>
    <span class="dim">&#40;</span>jdbc/execute! conn
      &#91;&quot;select regex&#95;capture<span class="dim">&#40;</span>?, 'Hello, world!'<span class="dim">&#41;</span>&quot;
       &quot;, <span class="dim">&#40;</span>world<span class="dim">&#41;</span>!&quot;&#93;<span class="dim">&#41;&#41;&#41;</span>
<span class="dim">
=&gt;</span>
&#91;{:regex&#95;capture<span class="dim">&#40;</span>?, 'Hello, world!'<span class="dim">&#41;</span> &quot;world&quot;}&#93;
</code></pre><p>Magic! SQLite is executing functions defined in Clojure.</p><h3 id="bonus%3A_automatically_compile_the_sql_functions">Bonus: Automatically compile the SQL functions</h3><p>To compile our SQLite function on repl launch add the following <code>:main-opts</code> to the <code>:dev</code> alias.</p><pre><code class="clojure">{:paths   &#91;&quot;src&quot; &quot;classes&quot;&#93;
 :deps
 {org.clojure/clojure               {:mvn/version &quot;1.11.1&quot;}
  com.github.seancorfield/next.jdbc {:mvn/version &quot;1.3.874&quot;}
  org.xerial/sqlite-jdbc            {:mvn/version &quot;3.42.0.0&quot;}}
 :aliases
 {:dev
  {:main-opts
   &#91<span class="dim">;;; Ensures application defined functions <strong>are</strong> compiled
</span>    <span class="dim">;; As they use gen-class to extend org.sqlite.Function
</span>    &quot;-e&quot; &quot;<span class="dim">&#40;</span>compile 'sqlite.db.application-defined-functions<span class="dim">&#41;</span>&quot;
    &quot;-r&quot;&#93;}}}
</code></pre><p>This means we don't have to remember to manually compile the SQLite functions (unless you change them during a repl session).</p><p>The full example <a href='https://github.com/andersmurphy/clj-cookbook/tree/master/sqlite/application-defined-sql-functions'>project can be found here</a>.</p><p>In a subsequent post I'll be sharing a helper macro that makes writing Application Defined SQL functions more convenient and more performant.</p></article><footer><p>© 2015-2024 Anders Murphy</p></footer></div></body></html>